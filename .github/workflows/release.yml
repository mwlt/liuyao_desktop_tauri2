name: "发布新版本"

on:
  push:
    tags:
      - 'v*'

jobs:
  # 创建 Release
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: '六爻排盘与研究 ${{ github.ref_name }}'
          body: |
            ## 🎉 六爻排盘与研究 ${{ github.ref_name }} 发布

            ### 📦 支持平台
            - **Windows**: MSI 安装包、NSIS 安装程序、便携版
            - **macOS**: Intel 专用版、Apple Silicon 专用版 (DMG格式)
            - **Linux**: DEB包、RPM包、AppImage 便携版

            ### 🔽 下载说明
            - **Windows 用户**: 
              - 安装版：下载 `.msi` 或 `.exe` 文件
              - 便携版：下载 `.zip` 文件
            - **macOS 用户**: 
              - Intel Mac: 下载包含 `intel` 的 `.dmg` 文件
              - Apple Silicon Mac: 下载包含 `apple_silicon` 的 `.dmg` 文件  
            - **Linux 用户**: 
              - Ubuntu/Debian: 下载 `.deb` 文件
              - RHEL/CentOS/Fedora: 下载 `.rpm` 文件
              - 其他发行版: 下载 `.AppImage` 文件
          draft: true
          prerelease: false

  # 构建并上传
  build-and-upload:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows 64位
          - platform: windows-latest
            os: windows
            arch: x86_64
            rust-target: x86_64-pc-windows-msvc
            artifact-name: windows-x64

          # Linux 64位
          - platform: ubuntu-22.04
            os: linux
            arch: x86_64
            rust-target: x86_64-unknown-linux-gnu
            artifact-name: linux-x64

          # macOS Intel 版本
          - platform: macos-latest
            os: macos
            arch: x86_64
            rust-target: x86_64-apple-darwin
            artifact-name: macos-intel

          # macOS Apple Silicon 版本
          - platform: macos-latest
            os: macos
            arch: aarch64
            rust-target: aarch64-apple-darwin
            artifact-name: macos-arm64

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Install frontend dependencies
        run: pnpm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      # 构建 Tauri 应用
      - name: Build Tauri app
        run: pnpm tauri build --target ${{ matrix.rust-target }}

      # Windows 便携版构建
      - name: Build Windows Portable Version
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd src-tauri
          .\scripts\build-portable.ps1

      # 创建 macOS APP 压缩包
      - name: Create macOS APP archive
        if: matrix.os == 'macos'
        shell: bash
        run: |
          app_dir="src-tauri/target/${{ matrix.rust-target }}/release/bundle/macos"
          if [ -d "$app_dir" ]; then
            cd "$app_dir"
            for app in *.app; do
              if [ -d "$app" ]; then
                tar -czf "${app}.tar.gz" "$app"
                echo "✅ 创建压缩包: ${app}.tar.gz"
              fi
            done
          fi

      # 收集所有构建产物
      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          
          # 定义目标目录
          target_dir="src-tauri/target/${{ matrix.rust-target }}/release/bundle"
          
          # Windows 产物
          if [ "${{ matrix.os }}" = "windows" ]; then
            # MSI
            find "$target_dir/msi" -name "*.msi" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
            # NSIS
            find "$target_dir/nsis" -name "*.exe" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
            # 便携版
            find "src-tauri/target/portable" -name "*.zip" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
          fi
          
          # macOS 产物
          if [ "${{ matrix.os }}" = "macos" ]; then
            # DMG
            find "$target_dir/dmg" -name "*.dmg" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
            # APP tar.gz
            find "$target_dir/macos" -name "*.app.tar.gz" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
          fi
          
          # Linux 产物
          if [ "${{ matrix.os }}" = "linux" ]; then
            # DEB
            find "$target_dir/deb" -name "*.deb" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
            # RPM
            find "$target_dir/rpm" -name "*.rpm" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
            # AppImage
            find "$target_dir/appimage" -name "*.AppImage" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
          fi
          
          echo "📦 收集到的产物："
          ls -la artifacts/

      # 上传产物到 GitHub Actions Artifacts（用于调试）
      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: artifacts/*
          retention-days: 1

      # 上传产物到 Release (Windows)
      - name: Upload Release Assets (Windows)
        if: matrix.os == 'windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        shell: pwsh
        run: |
          $uploadUrl = "${{ needs.create-release.outputs.upload_url }}"
          $uploadUrl = $uploadUrl -replace '\{.*\}', ''
          
          Get-ChildItem -Path "artifacts" -File | ForEach-Object {
            $filename = $_.Name
            $filepath = $_.FullName
            Write-Host "📤 上传: $filename"
            
            # 获取 MIME 类型
            $mime = switch -Regex ($filename) {
              '\.msi$' { "application/x-msi" }
              '\.exe$' { "application/x-msdownload" }
              '\.zip$' { "application/zip" }
              default { "application/octet-stream" }
            }
            
            # 使用 curl 上传文件
            $headers = @{
              "Authorization" = "token $env:GITHUB_TOKEN"
              "Content-Type" = $mime
            }
            
            $uri = "${uploadUrl}?name=${filename}"
            Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -InFile $filepath
          }

      # 上传产物到 Release (Unix)
      - name: Upload Release Assets (Unix)
        if: matrix.os != 'windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        shell: bash
        run: |
          upload_url="${{ needs.create-release.outputs.upload_url }}"
          
          # 遍历 artifacts 目录中的所有文件
          for file in artifacts/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "📤 上传: $filename"
              
              # 获取 MIME 类型
              case "${filename##*.}" in
                dmg) mime="application/x-apple-diskimage" ;;
                gz) mime="application/gzip" ;;
                deb) mime="application/vnd.debian.binary-package" ;;
                rpm) mime="application/x-rpm" ;;
                AppImage) mime="application/x-executable" ;;
                *) mime="application/octet-stream" ;;
              esac
              
              # 使用 curl 上传文件
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: $mime" \
                --data-binary "@$file" \
                "${upload_url%\{*}?name=$filename"
            fi
          done

      # 失败时上传日志
      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.artifact-name }}
          path: |
            src-tauri/target/**/build.log
            src-tauri/target/**/cargo-build.log
          if-no-files-found: ignore
          retention-days: 7